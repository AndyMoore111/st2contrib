---
version: '2.0'

hpe-icsp.icsp_id_to_os:
  input:
    - identifier
    - id_type
    - hostname
    - buildplan_uris 
    - connection_details
  tasks:
    fork_input:
      on-success:
        - get_mid_uuid: <% $.id_type = 'UUID' %>
        - get_mid_sn: <% $.id_type = 'serialnumber' %>
    get_mid_uuid:
      action: hpe-icsp.icsp_mid_get
      input:
        uuid: [<% $.identifier %>]
        connection_details: <% $.connection_details %>
      publish:
        icsp_mid: <% $.get_mid_uuid.result.mid %>
      retry:
        count: 5
        delay: 120
      on-success:
        - generate_server_data
    get_mid_sn:
      action: hpe-icsp.icsp_mid_get
      input:
        serialnumber: [<% $.identifier %>]
        connection_details: <% $.connection_details %>
      publish:
        icsp_mid: <% $.get_mid_sn.result.mid %>
      retry:
        count: 5
        delay: 120
      on-success:
        - generate_server_data
    generate_server_data:
      action: hpe-icsp.icsp_server_data_format
      input:
        mids: [<% $.icsp_mid %>]
        hostnames: [<% $.hostname %>]
      publish:
        icsp_serverdata:  <% $.generate_server_data.result %>
      on-success:
        - apply_buildplan
    apply_buildplan:
      action: hpe-icsp.icsp_buildplan_apply
      input:
        server_data: <% $.icsp_serverdata %>
        buildplan_uris: <% $.buildplan_uris %>
      publish:
        icsp_jobid: <% $.apply_buildplan.result.jobid %>
      on-success:
        - monitor_job
    monitor_job:
      action: hpe-icsp.icsp_job_status_get
      input:
        job_id: <% $.icsp_jobid %>
        monitor: True


